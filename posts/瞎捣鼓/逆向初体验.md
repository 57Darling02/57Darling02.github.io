---
title: 逆向初体验 
date: 2024-10-31 19:14:44
tags: 瞎捣鼓
copyright: true
---

# 逆向初体验

## 缘由

​	最近做实验，老师沿往年方案布置使用OPENTRACK列车仿真软件进行仿真实验。好巧不巧，这软件要授权，而且授权费特别贵（老师说一年二十万+）而且，只有实验室的几台电脑可以用。

​	老师给的解决方案是：实验32位的虚拟机安装这个软件，并使用老师给的安装包，利用32位保存的漏洞保存实验数据。

​	但实际使用时，我发现即使是32位系统也依旧无法完成数据保存：

![image-20250526111046134](./%E9%80%86%E5%90%91%E5%88%9D%E4%BD%93%E9%AA%8C.assets/image-20250526111046134.png)

即CTRL+S等功能不能使用。（按下会有报错音）

同时，新建自定义引擎（Engine）无法保存，在自定义的Train中无法调用新建的引擎。

（后面发现，老师发的版本似乎也有人做过修改😎，后面提）

## 逆向

​	老师让我们使用32位bug绕开保存限制，正好32位的window压根不设防，很方便对程序进行反编译和断点，

拖进Peid查一下壳：

![image-20250526111056210](./%E9%80%86%E5%90%91%E5%88%9D%E4%BD%93%E9%AA%8C.assets/image-20250526111056210.png)

纯正的味道😝，根本没加壳。

直接拖进OLLYDBG反编译看看源代码：

![image-20250526111100964](./%E9%80%86%E5%90%91%E5%88%9D%E4%BD%93%E9%AA%8C.assets/image-20250526111100964.png)

也是很正确的找到了程序入口点，也没有异常代码。确认没壳无疑了。

### 定点搜索

发现既然软件提示NOT Licensed

那么显示这段文字是就应该先判断是否有License，对这段字符进行ASCII码查找，找到很多出。一个个下断点后找到了打开软件时执行的判断函数：isLicensed -> isBlockedLicensed->ismac64....

跳转很多，找不到最后检查落点。于是直接将isLicensed函数整个跳过（取反），结果：

![image-20250526111105651](./%E9%80%86%E5%90%91%E5%88%9D%E4%BD%93%E9%AA%8C.assets/image-20250526111105651.png)

不仅功能用不了，甚至打不开了😢。遂放弃检查环节。

于是转变思路找Registration ，尝试在注册环节修改。果不其然，注册环节十分简单，在找了几十条字符串，断点测试相关代码后，在OTController registration OKpressed Master 下找到了注册相关的代码，发现注册按钮按下后（地址005A4080），完成校验的校验值放在于指向栈帧的底部的基址寄存器ebp下，然后使用了一个cmp byte指令[ebp-0x4]是否为0x01.

![image-20250526111109033](./%E9%80%86%E5%90%91%E5%88%9D%E4%BD%93%E9%AA%8C.assets/image-20250526111109033.png)

​	对这条指令进行修改，使校验结果位为0x00。

​	打包可执行文件进行验证。随意输入验证码进行注册后：

![image-20250526111112418](./%E9%80%86%E5%90%91%E5%88%9D%E4%BD%93%E9%AA%8C.assets/image-20250526111112418.png)

注册成功。但是程序应该是启动校验，功能还是用不了，懒得找执行启动校验的程序了。直接关闭软件重新打开。



![image-20250526111115397](./%E9%80%86%E5%90%91%E5%88%9D%E4%BD%93%E9%AA%8C.assets/image-20250526111115397.png)

至此，解锁所有功能。

## 最后

将可执行文件放到64位机子上，也能够成功完成注册。

幸运的是，这个软件2002年的老软件，因此没有将校验程序藏在动态链接库dll中（pycharm2024就是在程序本体和库中多层校验），不然估计我这种新手还真搞不定。

## 最后的最后

仅供交流学习使用，限24小时内删除。别抓我😭

