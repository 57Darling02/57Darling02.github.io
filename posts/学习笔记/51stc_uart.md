---
title:  单片机串口调用模块实践 
date: 2024-12-20 19:38:15
copyright: true
tags: 学习笔记 嵌入式
---

# 单片机串口调用模块实践

​	这是一篇关于微机原理课程结课设计的一些总结，使用51单片机的串口通讯调用WIFI模块esp-01进行多设备间通讯。

​	本来似乎可以使用物联网的开发环境进行，但是我们做的东西比较少，因此仅使用模块自带的AT指令集。

​	课设主要分为三个部分：1. 目标功能 2. 硬件设计 3. 软件设计

### 目标功能

​	设计一个实物作为热点发送wifi信号，同时也作为服务器监听该WiFi局域网下的某个ip的某个端口。当其他设备连接上该WiFi并向这个端口发送信息时，服务器处理信息并向发送信息的设备返回响应。（因为目前没想好其实际用途，响应就直接返回搜到的内容）

### 硬件设计

元件：ESP01S WIFI模块、AMS1117电源稳压模块、51单片机以及CH341A USB转TTL模块。

电路设计分为两个部分，分别是51单片机最小系统和WIFI模块。

##### 51单片机最小系统

由晶振电路、复位电路、通信串口、指示灯等四个关键部分组成。

1. 使用11.0592 MHz晶振和两个30pF电容连接至单片机的XTAL1和XTAL2引脚，形成稳定的时钟信号。
2. 采用电阻-电容（RC）复位电路方案，通过一个高阻值电阻（设计中选用1 kΩ）和一个低容值电容（设计中选用10 µF）连接至单片机的RST引脚。
3. 使用P2.0-P2.6作为7个指示灯的控制管脚。

##### ESP8266-ESP-01 WIFI模块

从WIFI模块实物图中可以看到，WIFI模块提供了一个2*4的外接管脚，让我们连接到自己的电路中控制，这8个管脚功能定义如下：

(1)  VCC：3.3V 电源。

(2)  RST：ES8266 复位管脚，可做外部硬件复位使用。

(3)  CH_PD：使能管脚，高电平有效。

(4)  UTXD：串口发送管脚，与开发板上串口的RXD相连。

(5)  URXD：串口接收管脚，与开发板上串口的TXD相连。

(6)  GPIO0：GPIO0 为高电平代表从 FLASH 启动，GPIO0 为低电平代表进入系统升级状态，此时可以经过串口升级内部固件。

(7)  GPIO2：此管脚为ESP8266引出的一个IO口。

(8)  GND：GND 管脚。

![esp-01s模块示意图](https://resource-un4.pages.dev/article/image-20241220200415596.png)

##### 稳压模块

​	稳压模块选用USB-5P 12V电压转5V、3.3VAMS1117稳压模块，该模块可作为MINIUSB接口转接板使用，MINIUSB母座的引均引出到焊盘。从MINIUSB接囗通过数据线输入5V电压，+5V焊点输出电压5V，3v3焊点输出电压3.3V。MINI USB接口也可以通过数据线或者从DC005电源座接口输入5-12V电压输入5-12V电压，依旧是+5V焊点输出电压等于输入5V，3.3V焊点输出电压3.3V。此外，该稳压模块具有电源指示灯。

​	针对51单片机需要5V电压供电的需求，我们将AMS1117模块输出的5V电压直接连接至51单片机的VCC引脚，以确保其正常工作。同时，考虑到ESP01S WIFI模块工作在3.3V电压下的特性，我们将AMS1117模块输出的3.3V电压连接至WIFI模块的VCC引脚，以满足其工作电压要求。

##### 实物

设计如下：

![设计图](https://resource-un4.pages.dev/article/image-20241220200616026.png)

实际焊接结果如下：

![实物焊接](https://resource-un4.pages.dev/article/image-20241220200809702.png)

### 软件设计

软件设计主要三步走：**模块调试**、**代码编写**、**刷入程序**

#### 模块调试

为了能够调用模块功能和处理模块的响应，我们需要先调试模块**以了解模块的响应特性和验证功能完整**。模块不同的固件可能会有不同的响应，而且手册给的指令集的响应结果也不会显示回车\r 换行\n等特殊字符，但我们处理时，需要对这些字符进行处理，因此我们会将响应的ASCII码转换为hex16进制下看结果。

##### 模块连接测试

CH341A 的TXD RXD分别连接ESP8266 RXD, TXD. 使用串口调试助手设置模块的默认波特率。输入AT(\r\n)。

其hex如下：

AT\r\n : 41 54 0D 0A 

\r\nOK\r\n : 0D 0A 4F 4B 0D 0A

##### 调整波特率

响应：

AT+UART_DEF=9600,8,1,0,0\r\n : 41 54 2B 55 41 52 54 5F 44 45 46 3D 39 36 30 30 2C 38 2C 31 2C 30 2C 30 0D 0A

\r\nOK\r\n : 0D 0A 4F 4B 0D 0A

##### AP模式设置

AT+CWMODE=2\r\n : 41 54 2B 43 57 4D 4F 44 45 3D 32 0D 0A

\r\nOK\r\n : 0D 0A 4F 4B 0D 0A

##### 配置服务主机IP地址和监听端口

设置WIFI的IP名为192.168.4.1

AT+CIPAP=\"192.168.4.1\"

开启TCP 服务器模式，监听端口 8080，等待客户端连接

"AT+CIPSERVER=1,8080"

使WIFI模块开启多连接模式

AT+CIPAP=\"192.168.4.1\"

##### 等待收到网络信息

成功配置了 TCP 服务器并启动监听端口后，模块将等待客户端连接并发送数据。当客户端发送数据时，模块会接收到这些数据，并返回相应的响应。例如，客服发送了数据“123456789”，模块接收到数据后，会返回响应“+IPD,0,9:123456789”，响应的ASCII码为：

0D 0A 2B 49 50 44 2C 30 2C 39 3A 31 32 33 34 35 36 37 38 39



可见区别于指令的响应，搜到网络消息的指令响应只有前面的0D0A（\r\n），而没有后面的结束符，因此在处理串口消息时，需要自己写代码判断消息是否结束，并主动处理。

##### 发送信息

AT+CIPSEND=0,5 这个命令将告诉模块即将向信道1发送5个字符的消息，待